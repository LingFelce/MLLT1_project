---
title: "metabric.Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# library(imsig)
library(dplyr)
library(tidyverse)
library(gplots)
library(RColorBrewer)
library(pheatmap)
library(DESeq2)
library(pheatmap)
library(ggplot2)
library (stringi)
library(AnnotationDbi)
library(edgeR)
library(DEFormats)
library(statmod)
library(BiocParallel)
library (limma)
library("genefilter")
```

Update 2nd October 2020

# ImgSig package to interrogate METABRIC dataset

Immune cell signature signatures for profiling the microenvironment of solid tumours https://cancerimmunolres.aacrjournals.org/content/6/11/1388

The genomic and transcriptomic architecture of 2,000 breast tumours reveals novel subgroups (METABRIC) https://www.nature.com/articles/nature10983

Should be able to download METABRIC dataset from European Genome-Phenome Archive (http://www.ebi.ac.uk/ega/) EGAS00000000083, but site seems to be down for now.

Managed to download from cBioPortal

```{r read in files}
clinical_sample <-read.delim("data_clinical_sample.txt", header=TRUE)

clinical_patient <- read.delim("data_clinical_patient.txt", header=TRUE, na.strings = c("", "NA"))

expression_median <- read.delim("data_expression_median.txt", header=TRUE, na.strings = c("", "NA"))

gene_matrix <-  read.delim("data_gene_matrix.txt", header=TRUE)

mrna_median_all_sample_zscores <- read.delim("data_mRNA_median_all_sample_Zscores.txt", header=TRUE)

mrna_median_zscores <-  read.delim("data_mRNA_median_Zscores.txt", header=TRUE)
## important ones to use: clinical_patient for survival information and expression_median for gene expression matrix (ImSig uses TPM/FPKM not Z-scores) ##
```


```{r preparing files for imsig}
# preparing expression data for ImSig
exp <- expression_median

# remove EntrezID
exp[2] <- NULL

# change . in patient IDs to - to match clinical data patient IDs
names(exp) <- gsub(x = names(exp), pattern = "\\.", replacement = "-")  

# remove any NA
exp <-  exp %>% na.omit()

# make gene symbols row names, and remove 1st column
rownames(exp) <- exp[,1]
exp[1] <- NULL

# preparing clinical data - keep only patient ID, overall survival in months and status (live/dead)
cli <- clinical_patient[,c(1, 13, 14)]

# remove top 4 rows (descriptive)
cli <- cli[-c(1,2,3, 4),]

# change column headings
names(cli)[names(cli) == "Overall.Survival..Months."] <- "time"
names(cli)[names(cli) == "Overall.Survival.Status"] <- "status"

# make patient IDs row names and remove column
rownames(cli) <- cli[,1]
cli[1] <- NULL

# remove row with no survival data (NA)
cli <-  cli %>% na.omit()

# change status to 0 and 1
cli$status[cli$status =="0:LIVING"] <- 0
cli$status[cli$status =="1:DECEASED"] <- 1
```

```{r running ImSig}
# table of stats on data
stats <-  gene_stat(exp = exp, r = 0.7)
```

```{r heatmap}
# heatmap of interferon alpha and interferon gamma gene expression from Hallmark gene sets compared with MLLT1 expression

# want patient MLLT1 expressing low to high on x axis, y axis different genes from ifn a and ifn g

# read in gene list - 298 (including MLLT1)
ifn_genes <- read.csv("ifna_ifng_hallmark.csv", header=TRUE)

# remove duplicated rows - 225 genes (also converts to character from vector?)
ifn_genes <-  ifn_genes[!duplicated(ifn_genes), ]

# want to use z-scores for simplicity
exp <- mrna_median_all_sample_zscores

# remove EntrezID
exp[2] <- NULL

# change . in patient IDs to - to match clinical data patient IDs
names(exp) <- gsub(x = names(exp), pattern = "\\.", replacement = "-")  

# remove any NA
exp <-  exp %>% na.omit()

# make gene symbols row names, and remove 1st column
rownames(exp) <- exp[,1]
exp[1] <- NULL


# select specific rows from expression matrix
ifn_exp <- exp[c(ifn_genes),]

# remove NA - 204 rows
ifn_exp <-  ifn_exp %>% na.omit()

# sort patients by MLLT1 expression low to high
sorted_ifn_exp <- ifn_exp[order(ifn_exp["MLLT1",]), drop=FALSE]


```

```{r fig.width=12, fig.height=20 }

# Generate heatmap - all patients

mat <- data.matrix(sorted_ifn_exp)

col.pan <- colorpanel(100, "green", "black", "red")

heatmap.2(mat, col=col.pan, Rowv=FALSE, Colv=FALSE, scale="row", trace="none", dendrogram="none", cexRow=0.1, cexCol=0.1, density.info="none")

# heat map only shows 400+ patients? Why? Does show all genes though


```

```{r fig.width=12, fig.height=20 }

# Generate heatmap - just low and high expressing patients (from cBioPortal EXP>1 and EXP<-1)

# read in patient IDs

high_ids <- read.csv("high_patient_ids.csv", header=TRUE)

low_ids <- read.csv("low_patient_ids.csv", header=TRUE)

# convert to character by removing duplicates, then remove brca_metabric from each name

high_ids <-  high_ids[!duplicated(high_ids), ]

high_ids <- high_ids %>% str_replace("brca_metabric:", "")

low_ids <-  low_ids[!duplicated(low_ids), ]

low_ids <- low_ids %>% str_replace("brca_metabric:", "")


# select specific just high and low patient ids
select_ifn_exp <- sorted_ifn_exp[c(high_ids, low_ids)]

# sort by MLLT1 expression 

sorted_select_ifn_exp <- select_ifn_exp[order(select_ifn_exp["MLLT1",]), drop=FALSE]

mat <- data.matrix(sorted_select_ifn_exp)

col.pan <- colorpanel(50, "green", "black", "red")

heatmap.2(mat, col=col.pan, Rowv=FALSE, Colv=FALSE, scale="column", trace="none", dendrogram="none", cexRow=0.1, cexCol=0.1, density.info="none")


```
